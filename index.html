<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EPG TV Guide</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #262626;
      color: white;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-family: "Martian Mono", monospace;
    }
    label {
      font-size: 18px;
    }
    select {
      padding: 8px;
      margin: 10px;
      font-size: 16px;
    }
    #epgContainer {
      margin-top: 20px;
      padding: 15px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      background: #333;
      border-radius: 10px;
    }
    .program {
      padding: 8px;
      border-bottom: 1px solid #444;
      margin-bottom: 10px;
    }
    .program:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <h1>EPG TV Guide</h1>
  <label for="provider">Pilih Provider:</label>
  <select id="provider" onchange="loadEPG()">
      <option value="">-- Pilih Provider --</option>
  </select>
  <div id="epgContainer"></div>
  
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      loadProviders();
    });
    
    // Memuat daftar provider dari providers.json
    function loadProviders() {
      fetch("providers.json")
          .then(response => response.json())
          .then(data => {
              let select = document.getElementById("provider");
              data.forEach(provider => {
                  let option = document.createElement("option");
                  option.value = provider.file;
                  option.textContent = provider.name;
                  select.appendChild(option);
              });
          })
          .catch(error => {
              console.error("Error loading providers:", error);
          });
    }
    
    // Memuat file XML EPG untuk provider yang dipilih
    function loadEPG() {
      let selectedFile = document.getElementById("provider").value;
      if (!selectedFile) {
          document.getElementById("epgContainer").innerHTML = "";
          return;
      }
    
      fetch(selectedFile)
          .then(response => response.text())
          .then(xmlText => {
              let parser = new DOMParser();
              let xmlDoc = parser.parseFromString(xmlText, "application/xml");
              displayEPG(xmlDoc);
          })
          .catch(error => {
              console.error("Error loading EPG:", error);
              document.getElementById("epgContainer").innerHTML = "<p>Error loading EPG.</p>";
          });
    }
    
    // Menampilkan program yang sedang tayang di setiap channel pada saat ini
    function displayEPG(xmlDoc) {
      let epgContainer = document.getElementById("epgContainer");
      epgContainer.innerHTML = "";
    
      let now = new Date();
      let programmes = xmlDoc.getElementsByTagName("programme");
      let channelPrograms = {}; // Menyimpan data: key = channel, value = program yang sedang tayang
    
      for (let i = 0; i < programmes.length; i++) {
          let prog = programmes[i];
          let startStr = prog.getAttribute("start");
          let stopStr = prog.getAttribute("stop");
          if (!startStr || !stopStr) continue;
    
          let startDate = parseXMLDate(startStr);
          let stopDate = parseXMLDate(stopStr);
    
          // Jika waktu saat ini berada di antara start dan stop
          if (now >= startDate && now <= stopDate) {
              let channel = prog.getAttribute("channel");
              let titleElem = prog.getElementsByTagName("title")[0];
              let title = titleElem ? titleElem.textContent : "No Title";
              channelPrograms[channel] = {
                  title: title,
                  start: startDate,
                  stop: stopDate
              };
          }
      }
    
      if (Object.keys(channelPrograms).length === 0) {
          epgContainer.innerHTML = "<p>Tidak ada program yang sedang tayang.</p>";
          return;
      }
    
      // Tampilkan data untuk tiap channel
      for (let channel in channelPrograms) {
          let program = channelPrograms[channel];
          let div = document.createElement("div");
          div.classList.add("program");
          let startTime = formatTime(program.start);
          let stopTime = formatTime(program.stop);
          div.innerHTML = `<strong>Channel:</strong> ${channel}<br>
                           <strong>Program:</strong> ${program.title}<br>
                           <strong>Waktu:</strong> ${startTime} - ${stopTime}`;
          epgContainer.appendChild(div);
      }
    }
    
    // Fungsi untuk mengubah format string tanggal dari XML (YYYYMMDDhhmmss) menjadi objek Date
    function parseXMLDate(timeStr) {
      // Jika terdapat informasi timezone, pisahkan dan gunakan bagian tanggalnya saja
      let parts = timeStr.split(" ");
      let datePart = parts[0];
      let year = parseInt(datePart.substring(0, 4));
      let month = parseInt(datePart.substring(4, 6)) - 1;
      let day = parseInt(datePart.substring(6, 8));
      let hour = parseInt(datePart.substring(8, 10));
      let minute = parseInt(datePart.substring(10, 12));
      let second = parseInt(datePart.substring(12, 14));
      return new Date(year, month, day, hour, minute, second);
    }
    
    // Fungsi untuk memformat objek Date menjadi HH:MM
    function formatTime(dateObj) {
      let hours = dateObj.getHours().toString().padStart(2, '0');
      let minutes = dateObj.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }
  </script>
</body>
</html>
